---
// TodoGroup.astro
import BaseModal from "./Modal/BaseModal.astro";
import CreateTodo from "./Modal/Content/CreateTodo.astro";
import DeleteTodo from "./Modal/Content/DeleteTodo.astro";
import UpdateTodo from "./Modal/Content/UpdateTodo.astro";

// Global type declaration for modalControls
declare global {
  interface Window {
    modalControls?: {
      [key: string]: {
        show: () => void;
        close: () => void;
      };
    };
  }
}
---

<section class="main-container">
  <div class="Board">
    <div>
      <h2>Task List</h2>
      <div id="todoList"></div>
      <button id="add-todo">Add Task</button>
    </div>
    <BaseModal title={"Create Task"} id="create-todo-modal">
      <CreateTodo />
    </BaseModal>
    <BaseModal title={"Update Task"} id="update-todo-modal">
      <UpdateTodo />
    </BaseModal>
    <BaseModal title={"Delete Task"} id="delete-todo-modal">
      <DeleteTodo />
    </BaseModal>
  </div>
</section>

<script>
  import { TodoCard } from "./TodoCard";
  import { TodoContext } from "@contexts/todoContext";
  import { handleDelete } from "@utils/handleDelete";
  import { handleEdit } from "@utils/handleEdit";

  document.addEventListener("DOMContentLoaded", () => {
    const todoContext = TodoContext.getInstance();
    const todoList = document.getElementById("todoList");

    function renderTodos() {
      if (!todoList) return;

      const todos = todoContext.getTodos();

      const todoElements = todos.map((todo) => TodoCard(todo)).join("");
      todoList.innerHTML = todoElements;

      addEventListeners();
    }

    function showModal(modalId: string) {
      const modalControls = window.modalControls;
      if (!modalControls) {
        console.error("modalControls not found");
        return;
      }
      modalControls[modalId].show();
    }

    function addEventListeners() {
      if(!todoList) return;
      const editButtons = todoList.querySelectorAll(".edit-button");
      const deleteButtons = todoList.querySelectorAll(".delete-button");

      editButtons.forEach((button) => {
        button.addEventListener("click", (e) => {
          e.preventDefault();
          const todoId = (e.currentTarget as HTMLButtonElement).dataset.todoId;
          if (todoId) {
            handleEdit(todoId);
          }
        });
      });

      deleteButtons.forEach((button) => {
        button.addEventListener("click", (e) => {
          e.preventDefault();
          const todoId = (e.currentTarget as HTMLButtonElement).dataset.todoId;
          if (todoId) {
            handleDelete(todoId);
          }
        });
      });
    }

   

    renderTodos();

    const addTodoButton = document.getElementById("add-todo");
    if (addTodoButton) {
      addTodoButton.addEventListener("click", () => {
        showModal("create-todo-modal");
      });
    }
  });
</script>
