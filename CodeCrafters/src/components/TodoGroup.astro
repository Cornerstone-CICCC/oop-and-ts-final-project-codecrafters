---
// TodoGroup.astro
import BaseModal from "@components/Modal/BaseModal.astro";
import CreateTodo from "@components/Modal/Content/CreateTodo.astro";
import DeleteTodo from "@components/Modal/Content/DeleteTodo.astro";
import UpdateTodo from "@components/Modal/Content/UpdateTodo.astro";
import { TodoModalType } from "@utils/todoModalType";
import ViewTodo from "./Modal/Content/ViewTodo.astro";

// Global type declaration for modalControls
declare global {
  interface Window {
    modalControls?: {
      [key: string]: {
        show: () => void;
        close: () => void;
      };
    };
  }
}
---

<section class="main-container">
  <div class="Board">
    <div>
      <h2>Task List</h2>
      <div id="todoList"></div>
      <button id="add-todo">Add Task</button>
    </div>
    <BaseModal title={"Create Task"} id={TodoModalType.CREATE}>
      <CreateTodo />
    </BaseModal>
    <BaseModal title={"Update Task"} id={TodoModalType.UPDATE}>
      <UpdateTodo />
    </BaseModal>
    <BaseModal title={"Delete Task"} id={TodoModalType.DELETE}>
      <DeleteTodo />
    </BaseModal>

    <BaseModal title={"View Task Detail"} id={TodoModalType.VIEW}>
      <ViewTodo />
    </BaseModal>
  </div>
</section>

<script>
  import { addEventListeners, TodoCard } from "./TodoCard";
  import { TodoContext } from "@contexts/todoContext";
  import { TodoModalType } from "@utils/todoModalType";

  document.addEventListener("DOMContentLoaded", () => {
    const todoContext = TodoContext.getInstance();
    const todoList = document.getElementById("todoList");

    function renderTodos() {
      if (!todoList) return;

      const todos = todoContext.getTodos();

      const todoElements = todos.map((todo) => TodoCard(todo)).join("");
      todoList.innerHTML = todoElements;

      addEventListeners(todoList);
    }

    function showModal(modalId: string) {
      const modalControls = window.modalControls;
      if (!modalControls) {
        console.error("modalControls not found");
        return;
      }
      modalControls[modalId].show();
    }

    renderTodos();

    const addTodoButton = document.getElementById("add-todo");
    if (addTodoButton) {
      addTodoButton.addEventListener("click", () => {
        showModal(TodoModalType.CREATE);
      });
    }
  });
</script>
